document.addEventListener('DOMContentLoaded',async()=>{const CACHE_KEY='address_book_cache_v2';const CACHE_VERSION_KEY='cache_version';const LOGIN_EXPIRY_KEY='login_expiry';const EXPANDED_STATE_KEY='expanded_departments';const loginPage=document.getElementById('loginPage');const dataPage=document.getElementById('dataPage');const passwordInput=document.getElementById('passwordInput');const loginBtn=document.getElementById('loginBtn');const loginError=document.getElementById('loginError');const departmentList=document.getElementById('departmentList');const FIFTEEN_DAYS=15*24*60*60*1000;init();async function init(){try{const isCacheValid=await checkCacheUpdate();if(!isCacheValid){await loadAndCacheAllResources()}await checkLoginStatus()}catch(error){console.error('初始化失败:',error);showLoginError('系统初始化失败，请重试')}}async function checkCacheUpdate(){let serverVersion=window.preloadData.time;if(!serverVersion){const res=await fetch(`time.js?t=${Date.now()}`);serverVersion=(await res.text()).trim()}const localVersion=localStorage.getItem(CACHE_VERSION_KEY);return serverVersion&&localVersion&&serverVersion===localVersion}async function loadAndCacheAllResources(){try{const timestamp=Date.now();let time=window.preloadData.time;let code=window.preloadData.code;if(!time){const timeRes=await fetch(`time.js?t=${timestamp}`);time=(await timeRes.text()).trim()}if(!code){const codeRes=await fetch(`code.js?t=${timestamp}`);code=(await codeRes.text()).trim()}const[dataRes,cssRes,jsRes,htmlRes]=await Promise.all([fetch(`data.js?t=${timestamp}`),fetch(`main.css?t=${timestamp}`),fetch(`app.js?t=${timestamp}`),fetch(`index.html?t=${timestamp}`)]);if(![dataRes,cssRes,jsRes,htmlRes].every(r=>r.ok)){throw new Error('部分资源加载失败');}const cacheData={time,code,data:await dataRes.text(),css:await cssRes.text(),js:await jsRes.text(),html:await htmlRes.text()};localStorage.setItem(CACHE_KEY,JSON.stringify(cacheData));localStorage.setItem(CACHE_VERSION_KEY,cacheData.time.trim());console.log('资源缓存更新成功')}catch(error){console.error('资源缓存失败:',error);throw new Error('资源加载失败，请检查网络');}}async function checkLoginStatus(){const savedPwd=localStorage.getItem('saved_password');const expiryTime=localStorage.getItem(LOGIN_EXPIRY_KEY);const now=Date.now();if(savedPwd&&expiryTime&&now<parseInt(expiryTime)){try{let serverPwd=window.preloadData.code;if(!serverPwd){const res=await fetch(`code.js?t=${Date.now()}`);serverPwd=(await res.text()).trim()}if(savedPwd===serverPwd){loginPage.style.display='none';dataPage.style.display='block';renderDataPage();return}}catch(error){console.error('密码比对失败:',error)}}setupLoginHandler()}function setupLoginHandler(){loginBtn.addEventListener('click',async()=>{const inputPwd=passwordInput.value.trim();if(!inputPwd){showLoginError('请输入密码');return}try{let serverPwd=window.preloadData.code;if(!serverPwd){const res=await fetch(`code.js?t=${Date.now()}`);serverPwd=(await res.text()).trim()}if(inputPwd===serverPwd){const expiryTime=Date.now()+FIFTEEN_DAYS;localStorage.setItem('saved_password',inputPwd);localStorage.setItem(LOGIN_EXPIRY_KEY,expiryTime.toString());showLoginError('登录成功，15天内免登录','green');setTimeout(()=>{loginPage.style.display='none';dataPage.style.display='block';renderDataPage()},1000)}else{showLoginError('密码错误，请重新输入')}}catch(error){console.error('登录验证失败:',error);showLoginError('验证失败，请重试')}});passwordInput.addEventListener('keypress',(e)=>{if(e.key==='Enter')loginBtn.click()})}function renderDataPage(){try{const cacheData=JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');const dataText=cacheData.data||'';const lines=dataText.split('\n').map(line=>line.trim()).filter(line=>line.length>0);const departments=parseData(lines);departmentList.innerHTML='';renderDepartments(departments,departmentList,1);restoreExpandedState()}catch(error){console.error('数据渲染失败:',error);departmentList.innerHTML=`<div style="padding: 5%; text-align: center; color: red; font-size: 4vw;">数据加载失败</div>`}}function parseData(lines){const rootDepartments=[];const levelStack=[];lines.forEach(line=>{if(line.match(/^\d+-/)){const[levelStr,name]=line.split('-',2).map(item=>item.trim());const level=parseInt(levelStr,10);if(isNaN(level)||!name)return;const department={name,level,members:[],children:[]};if(level===1){rootDepartments.push(department);levelStack.length=0;levelStack.push(department)}else{while(levelStack.length>=level)levelStack.pop();if(levelStack.length>0){levelStack[levelStack.length-1].children.push(department);levelStack.push(department)}}}else if(line.match(/-/g)?.length>=2){const[dept,name,phone]=line.split('-').map(item=>item.trim());if(dept&&name&&phone&&levelStack.length>0){levelStack[levelStack.length-1].members.push({dept,name,phone})}}});return rootDepartments}function renderDepartments(departments,container,level,parentId=''){departments.forEach((dept,index)=>{const deptId=parentId?`${parentId}-${index}`:`dept-${index}`;const group=document.createElement('div');group.className='department-group';group.dataset.id=deptId;const headerClass=`level-${level}-header`;const header=document.createElement('div');header.className=headerClass;header.textContent=dept.name;header.dataset.id=deptId;header.dataset.level=level;const content=document.createElement('div');content.className='department-content';content.id=`content-${deptId}`;const memberList=document.createElement('div');memberList.className='member-list';dept.members.forEach(member=>{const memberItem=document.createElement('div');memberItem.className='member-item';memberItem.innerHTML=`<span class="member-name">${member.name}（${member.dept}）</span><a href="tel:${member.phone}"class="member-phone">${member.phone}</a>`;memberList.appendChild(memberItem)});const childrenContainer=document.createElement('div');renderDepartments(dept.children,childrenContainer,level+1,deptId);content.appendChild(memberList);content.appendChild(childrenContainer);group.appendChild(header);group.appendChild(content);container.appendChild(group)})}departmentList.addEventListener('click',(e)=>{const header=e.target.closest(`.level-1-header,.level-2-header,.level-3-header,.level-4-header`);if(header){const deptId=header.dataset.id;const level=parseInt(header.dataset.level);toggleDepartment(deptId,level)}});function toggleDepartment(deptId,level){const header=document.querySelector(`.level-${level}-header[data-id="${deptId}"]`);const content=document.getElementById(`content-${deptId}`);if(header&&content){header.classList.toggle('expanded');content.classList.toggle('expanded');saveExpandedState()}}function saveExpandedState(){const expandedIds=[];document.querySelectorAll('.level-1-header.expanded, .level-2-header.expanded, .level-3-header.expanded, .level-4-header.expanded').forEach(header=>{expandedIds.push(header.dataset.id)});localStorage.setItem(EXPANDED_STATE_KEY,JSON.stringify(expandedIds))}function restoreExpandedState(){const expandedIds=JSON.parse(localStorage.getItem(EXPANDED_STATE_KEY)||'[]');expandedIds.forEach(deptId=>{for(let level=1;level<=4;level++){const header=document.querySelector(`.level-${level}-header[data-id="${deptId}"]`);const content=document.getElementById(`content-${deptId}`);if(header&&content){header.classList.add('expanded');content.classList.add('expanded');break}}})}function showLoginError(message,color='red'){loginError.textContent=message;loginError.style.color=color;loginError.style.display='block';if(color!=='red'){setTimeout(()=>{loginError.style.display='none'},3000)}}});